<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
	<title>[[#{menu.map}]]</title>
	<th:block th:insert="~{inc/asset.html :: templates_css}"></th:block>
	<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1669ac115ebaa35601888df2a635eb83&libraries=services"></script>
</head>
<style>
	.map-container {
		padding: 0 70px;
	}
	
	.map-heading {
		display: flex;
		gap: 28px;
	}

	#map {
		width: 1390px;
		height: 872px;
		border: 1px solid #F3F2F2;
	}

	.map-box {
		display: flex;
		justify-content: space-between;
		width: 1780px;
		height: 872px;
		margin-top: 55px;
	}
	
	.map-search-box {
		width: 390px;
		border: 1px solid #F3F2F2;
	}

	.map-search { 
	    height: 150px;
	    background-color: #F7F7F7;  
	}
	
	.sido-gugun {
		display: flex;
		gap: 10px;
	    padding-top: 22px;
		align-items: center;
		justify-content: center;
	}
	
	.sido-gugun select {
		width: 176px;
		height: 43px; 
		border-radius: 4px;
		border: 1px solid #E9ECEF;
		font-size: 16px;
		font-family: "untree", "Semantic", "Input";
		-webkit-appearance: none;  
		-moz-appearance: none; 
		appearance: none;  
		background: url(img/map/selectbox-down.svg) no-repeat 95% 50%;
		display: inline-block;
	    padding-left: 10px;
	    background-color: white;
	}
	
	.address-search {
		display: flex;
		justify-content: center;
		margin-top: 17px;
	}
	
	.address-search input[type=text] {
		width: 360px;
		height: 43px;
		border-radius: 4px;
		border: 1px solid #E9ECEF;
	}
	
	.search-input {
	    width: 360px;
	    height: 43px;
	    border-radius: 4px;
	    border: 1px solid #E9ECEF;
	    padding-right: 40px; /* 아이콘 공간 확보 */
	    background: url('img/map/search.svg') no-repeat right 10px center; /* 아이콘을 오른쪽에 배치 */
	    background-color: white;
	    background-size: 20px 20px; /* 아이콘 크기 조정 */
	    font-size: 16px;
	    padding-left: 10px;
	}
	
	.search-input:focus {
	    outline: none;
	}
	
	/*   <ul id="placesList"></ul> <div id="pagination"></div> */
	
	#placesList {
		max-height: 724px;
	}
	
	#placesList li {
		height: 177px;
	}

</style>
<body>
	<th:block th:insert="~{inc/header.html :: index_header}"></th:block>
	<div class="map-container">
		<div class="section services-section">
			<div class="col-lg-5 aos-init aos-animate" data-aos="fade-up" data-aos-delay="">
				<h3 class="subheading">Pharmacy Map</h3>
				<h2 class="map-heading heading">
					<img src="img/map/mapIcon.svg" class="map-icon">
					약국 찾기
				</h2>
				
				<div class="map-box">
					<div class="map-search-box">
						<div class="map-search">
							<div class="sido-gugun">
								<select name="sido1" id="sido1"></select>
								<select name="gugun1" id="gugun1"></select>
							</div>
							<div id="menu_wrap" class="bg_white">
								<div class="option">
									<div class="address-search">
										<form onsubmit="searchPlaces(); return false;">
											<input type="text" id="keyword" placeholder="검색어를 입력하세요." class="search-input">
										</form>
									</div>
								</div>
						        <ul id="placesList"></ul>
						        <div id="pagination"></div>
					        </div>
						</div>
					</div>
					<div id="map"></div> 
				</div>
			</div>		
		</div>		
	</div>
	<th:block th:insert="~{inc/footer.html :: footer}"></th:block>
	<th:block th:insert="~{inc/asset.html :: templates_js}"></th:block>

</body>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>	
	
		/*
        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(33.450701, 126.570667),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);
		*/
		
		
		$('document').ready(function() {
			var area0 = ["시/도 선택","서울특별시","인천광역시","대전광역시","광주광역시","대구광역시","울산광역시","부산광역시","경기도","강원도","충청북도","충청남도","전라북도","전라남도","경상북도","경상남도","제주도"];
			var area1 = ["강남구","강동구","강북구","강서구","관악구","광진구","구로구","금천구","노원구","도봉구","동대문구","동작구","마포구","서대문구","서초구","성동구","성북구","송파구","양천구","영등포구","용산구","은평구","종로구","중구","중랑구"];
			var area2 = ["계양구","남구","남동구","동구","부평구","서구","연수구","중구","강화군","옹진군"];
			var area3 = ["대덕구","동구","서구","유성구","중구"];
			var area4 = ["광산구","남구","동구",     "북구","서구"];
			var area5 = ["남구","달서구","동구","북구","서구","수성구","중구","달성군"];
			var area6 = ["남구","동구","북구","중구","울주군"];
			var area7 = ["강서구","금정구","남구","동구","동래구","부산진구","북구","사상구","사하구","서구","수영구","연제구","영도구","중구","해운대구","기장군"];
			var area8 = ["고양시","과천시","광명시","광주시","구리시","군포시","김포시","남양주시","동두천시","부천시","성남시","수원시","시흥시","안산시","안성시","안양시","양주시","오산시","용인시","의왕시","의정부시","이천시","파주시","평택시","포천시","하남시","화성시","가평군","양평군","여주군","연천군"];
			var area9 = ["강릉시","동해시","삼척시","속초시","원주시","춘천시","태백시","고성군","양구군","양양군","영월군","인제군","정선군","철원군","평창군","홍천군","화천군","횡성군"];
			var area10 = ["제천시","청주시","충주시","괴산군","단양군","보은군","영동군","옥천군","음성군","증평군","진천군","청원군"];
			var area11 = ["계룡시","공주시","논산시","보령시","서산시","아산시","천안시","금산군","당진군","부여군","서천군","연기군","예산군","청양군","태안군","홍성군"];
			var area12 = ["군산시","김제시","남원시","익산시","전주시","정읍시","고창군","무주군","부안군","순창군","완주군","임실군","장수군","진안군"];
			var area13 = ["광양시","나주시","목포시","순천시","여수시","강진군","고흥군","곡성군","구례군","담양군","무안군","보성군","신안군","영광군","영암군","완도군","장성군","장흥군","진도군","함평군","해남군","화순군"];
			var area14 = ["경산시","경주시","구미시","김천시","문경시","상주시","안동시","영주시","영천시","포항시","고령군","군위군","봉화군","성주군","영덕군","영양군","예천군","울릉군","울진군","의성군","청도군","청송군","칠곡군"];
			var area15 = ["거제시","김해시","마산시","밀양시","사천시","양산시","진주시","진해시","창원시","통영시","거창군","고성군","남해군","산청군","의령군","창녕군","하동군","함안군","함양군","합천군"];
			var area16 = ["서귀포시","제주시","남제주군","북제주군"];

			// 시/도 선택 박스 초기화
			$("select[name^=sido]").each(function() {
				$selsido = $(this);
				$.each(eval(area0), function() {
					$selsido.append("<option value='"+this+"'>"+this+"</option>");
				});
				$selsido.next().append("<option value=''>구/군 선택</option>");
			});
			
			 // 시/도 선택시 구/군 설정
			$("select[name^=sido]").change(function() {
				
				var area = "area"+$("option",$(this)).index($("option:selected",$(this))); // 선택지역의 구군 Array
				var $gugun = $(this).next(); // 선택영역 군구 객체
				$("option",$gugun).remove(); // 구군 초기화
		
				if(area == "area0")  $gugun.append("<option value=''>구/군 선택</option>");
				else {
					$.each(eval(area), function() {
						$gugun.append("<option value='"+this+"'>"+this+"</option>");
					});
				}
			});
		}); 

		var markers = [];

		var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
			mapOption = {
				center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
				level: 3 // 지도의 확대 레벨
			};  

		// 지도를 생성합니다    
		var map = new kakao.maps.Map(mapContainer, mapOption); 

		// 장소 검색 객체를 생성합니다
		var ps = new kakao.maps.services.Places();  

		// 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
		var infowindow = new kakao.maps.InfoWindow({zIndex:1});

		// 키워드로 장소를 검색합니다
		searchPlaces();

		// 키워드 검색을 요청하는 함수입니다
		function searchPlaces() {
		 
			var keyword = document.getElementById('keyword').value.trim();

			if (!keyword.replace(/^\s+|\s+$/g, '')) {
				//alert('키워드를 입력해주세요!');
				return false;
			}

			// 장소검색 객체를 통해 키워드로 장소검색을 요청합니다
			ps.keywordSearch( keyword, placesSearchCB); 
		}

		// 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
		function placesSearchCB(data, status, pagination) {
			if (status === kakao.maps.services.Status.OK) {

				// 정상적으로 검색이 완료됐으면
				// 검색 목록과 마커를 표출합니다
				displayPlaces(data);

				// 페이지 번호를 표출합니다
				displayPagination(pagination);

			} else if (status === kakao.maps.services.Status.ZERO_RESULT) {

				alert('검색 결과가 존재하지 않습니다.');
				return;

			} else if (status === kakao.maps.services.Status.ERROR) {

				alert('검색 결과 중 오류가 발생했습니다.');
				return;

			}
		}

		// 검색 결과 목록과 마커를 표출하는 함수입니다
		function displayPlaces(places) {

			var listEl = document.getElementById('placesList'), 
			menuEl = document.getElementById('menu_wrap'),
			fragment = document.createDocumentFragment(), 
			bounds = new kakao.maps.LatLngBounds(), 
			listStr = '';
			
			// 검색 결과 목록에 추가된 항목들을 제거합니다
			removeAllChildNods(listEl);

			// 지도에 표시되고 있는 마커를 제거합니다
			removeMarker();
			
			for ( var i=0; i<places.length; i++ ) {

				// 마커를 생성하고 지도에 표시합니다
				var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x),
					marker = addMarker(placePosition, i), 
					itemEl = getListItem(i, places[i]); // 검색 결과 항목 Element를 생성합니다

				// 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
				// LatLngBounds 객체에 좌표를 추가합니다
				bounds.extend(placePosition);

				// 마커와 검색결과 항목에 mouseover 했을때
				// 해당 장소에 인포윈도우에 장소명을 표시합니다
				// mouseout 했을 때는 인포윈도우를 닫습니다
				(function(marker, title) {
					kakao.maps.event.addListener(marker, 'mouseover', function() {
						displayInfowindow(marker, title);
					});

					kakao.maps.event.addListener(marker, 'mouseout', function() {
						infowindow.close();
					});

					itemEl.onmouseover =  function () {
						displayInfowindow(marker, title);
					};

					itemEl.onmouseout =  function () {
						infowindow.close();
					};
				})(marker, places[i].place_name);

				fragment.appendChild(itemEl);
			}

			// 검색결과 항목들을 검색결과 목록 Element에 추가합니다
			listEl.appendChild(fragment);
			menuEl.scrollTop = 0;

			// 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
			map.setBounds(bounds);
		}

		// 검색결과 항목을 Element로 반환하는 함수입니다
		function getListItem(index, places) {

			var el = document.createElement('li'),
			itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
						'<div class="info">' +
						'   <h5>' + places.place_name + '</h5>';

			if (places.road_address_name) {
				itemStr += '    <span>' + places.road_address_name + '</span>' +
							'   <span class="jibun gray">' +  places.address_name  + '</span>';
			} else {
				itemStr += '    <span>' +  places.address_name  + '</span>'; 
			}
						
			itemStr += '  <span class="tel">' + places.phone  + '</span>' +
						'</div>';           

			el.innerHTML = itemStr;
			el.className = 'item';

			return el;
		}

		// 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
		function addMarker(position, idx, title) {
			var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
				imageSize = new kakao.maps.Size(36, 37),  // 마커 이미지의 크기
				imgOptions =  {
					spriteSize : new kakao.maps.Size(36, 691), // 스프라이트 이미지의 크기
					spriteOrigin : new kakao.maps.Point(0, (idx*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
					offset: new kakao.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
				},
				markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
					marker = new kakao.maps.Marker({
					position: position, // 마커의 위치
					image: markerImage 
				});

			marker.setMap(map); // 지도 위에 마커를 표출합니다
			markers.push(marker);  // 배열에 생성된 마커를 추가합니다

			return marker;
		}

		// 지도 위에 표시되고 있는 마커를 모두 제거합니다
		function removeMarker() {
			for ( var i = 0; i < markers.length; i++ ) {
				markers[i].setMap(null);
			}   
			markers = [];
		}

		// 검색결과 목록 하단에 페이지번호를 표시는 함수입니다
		function displayPagination(pagination) {
			var paginationEl = document.getElementById('pagination'),
				fragment = document.createDocumentFragment(),
				i; 

			// 기존에 추가된 페이지번호를 삭제합니다
			while (paginationEl.hasChildNodes()) {
				paginationEl.removeChild (paginationEl.lastChild);
			}

			// 페이지 번호 생성
			for (i=1; i<=pagination.last; i++) {
				var el = document.createElement('a');
				el.href = "#";
				el.innerHTML = i;

				// 현재 페이지는 강조 표시
				if (i===pagination.current) {
					el.className = 'on';
				} else {
					el.onclick = (function(i) {
						return function() {
							console.log('go to Page!!!!!!!!!!!!!!!!!!!! ' + i);
							pagination.gotoPage(i); // 해당 페이지로 이동
						}
					})(i);
				}

				fragment.appendChild(el);
			}
			paginationEl.appendChild(fragment);
		}

		// 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
		// 인포윈도우에 장소명을 표시합니다
		function displayInfowindow(marker, title) {
			var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

			infowindow.setContent(content);
			infowindow.open(map, marker);
		}

		// 검색결과 목록의 자식 Element를 제거하는 함수입니다
		function removeAllChildNods(el) {   
			while (el.hasChildNodes()) {
				el.removeChild (el.lastChild);
			}
		}
	</script>
</html>
