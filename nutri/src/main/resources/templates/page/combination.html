<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="UTF-8">
<!--/*	<meta name="_csrf" th:content="${_csrf.token}"/>
	<meta name="_csrf_header" th:content="${_csrf.headerName}"/> */-->

<title>[[#{menu.combination}]]</title>
<th:block th:insert="~{inc/asset.html :: templates_css}"></th:block>
<style>
/* 영양성분 선택 -------------------------------- */
.ingredient_category {
	display: grid;
	grid-template-columns: repeat(3, 1fr);
	margin-top: 55px;
}

.ingredient_category_radio_btn {
	display: inline-block;
	margin-top: 20px;
	margin-bottom: 20px;
}

.ingredient_category_radio_btn label {
	width: 260px;
	height: 70px;
	display: flex;
	justify-content: center;
	align-items: center;
	border: 1px solid var(--bs-gray);
	border-radius: 10px;
	margin: 0 auto;
	font-size: 22px;
	color: var(--bs-gray-dark);
}

.ingredient_category_radio_btn input[type=radio] {
	display: none;
}

.ingredient_category_radio_btn input[type=radio]:checked+label {
	background: var(--bs-primary);
	color: var(--bs-white);
	border: none;
}

.ingredient_category_radio_btn label:hover {
	color: var(--bs-white);
	background: var(--bs-primary);
	border: none;
}


/* 선택된 영양성분 -------------------------------- */
.section.select_ingredient_one {
	background-color: #F8F9FA;
	padding-top : 50px;
	padding-bottom : 10px;
	height : 650px;
}

.row {
	margin: 10px;
}

/* 선택된 영양성분 기능 -------------------------------- */
.block-testimonial .author {
	display: flex;
	flex-direction: column;
}

.block-testimonial .author img {
	align-self: center;
	width: 180px;
	height: 180px;
}

.block-testimonial .author h3 {
	font-size: 25px;
	margin-top: 30px;
	margin-left: 20px;
}

.block-testimonial .author p {
	font-size: 17px;
	margin-top: 20px;
	margin-left: 20px;
}

/* 선택된 영양제와 조합인 이유 -------------------------------- */
.accordion-body {
	display: grid;
	grid-template-columns: 100px 410px 45px;
	background-color: white;
	border: 1px solid var(--bs-light);
}

.accordion-body a {
	margin-left: 10px;
	margin-right: 0px;
}

.heading.mb-5 {
	font-size: 35px;
}



/* 같이 먹으면 좋은 조합과 아닌 조합 */
#combinationGood{
	display : none; 
}

#combinationBad{
	display : none; 
}


</style>

</head>

<body>
	<th:block th:insert="~{inc/header.html :: index_header_menu}"></th:block>
	<th:block
		th:insert="~{inc/header.html :: index_header_content_basic(#{menu.combination},#{menu.combination.desc})}">
	</th:block>

	<div id="combination-container">
		<div class="section">
			<div class="container">
				<div class="row mb-5">
					<div class="col-lg-5" data-aos="fade-up" data-aos-delay="">
						<h3 class="subheading">영양제 조합</h3>
						<h2 class="heading">영양제 성분 카테고리</h2>
					</div>
					<!-- 카테고리 선택  -->
					<form method="POST" action="/combination/ajax">
						<div class="ingredient_category">
							<div th:each="seqName : ${ingredientSeqName}"
								class="ingredient_category_radio_btn">
								<input th:id="'ingredient_' + ${seqName.key}" type="radio"
									name="select_ingredient" th:value="${seqName.key}"> <label
									th:for="'ingredient_' + ${seqName.key}"> <span
									th:text="${seqName.value}"></span>
								</label>
							</div>
						</div>
					</form>
				</div>
				<div class="section select_ingredient_one">
					<div class="container">
						<div class="row ">
							<div class="col-lg-5 mb-5 mb-lg-0 me-auto testimonial-wrap"
								data-aos="fade-up" data-aos-delay="0">
								<h3 class="subheading">선택된 영양제</h3>
								<h2 class="heading mb-5 selectOne">오메가3</h2>

								<div class="wide-slider-testimonial-wrap">

									<div class="wide-slider-testimonial">
										<div class="item">
											<blockquote class="block-testimonial">
												<div class="author">
													<img src="/img/ingredient/오메가3.png" id="selectOneImg">
													<h3>효능</h3>
													<p id="ingredientContent">기능 넣을 거임</p>
												</div>
											</blockquote>
										</div>
									</div>
								</div>
							</div>




							<div class="col-lg-6 mt-4 mt-lg-0" data-aos="fade-up"
								data-aos-delay="100" id="combinationButton">
								<h3 class="subheading">선택된 영양제와 관련된 성분 조합</h3>
								<h2 class="heading mb-5">
									<span class="selectOne">칼슘</span>과(와) 관련된 성분 조합은?
								</h2>

								<div class="custom-accordion" id="accordion_1">
									<div class="accordion-item" id="combinationGood">
										<h2 class="mb-0">
											<button class="btn btn-link" type="button"
												data-bs-toggle="collapse" data-bs-target="#collapseOne"
												aria-expanded="true" aria-controls="collapseOne">같이
												먹으면 좋은 조합</button>
										</h2>

										<div id="collapseOne" class="collapse show"
											aria-labelledby="headingOne" data-bs-parent="#accordion_1">
											

										</div>
									</div>
									<!-- .accordion-item -->

									<div class="accordion-item"  id="combinationBad">
										<h2 class="mb-0">
											<button class="btn btn-link" type="button"
												data-bs-toggle="collapse" data-bs-target="#collapseTwo"
												aria-expanded="false" aria-controls="collapseTwo">같이
												먹으면 안 좋은 조합</button>
										</h2>
										<div id="collapseTwo" class="collapse"
											aria-labelledby="headingTwo" data-bs-parent="#accordion_1">
										</div>
										<!-- .accordion-item -->

									</div>
								</div>
							</div>
						</div>
						<!-- .container -->
					</div>
					<!-- /.untree_co-section -->
				</div>


			</div>
			<th:block th:insert="~{inc/footer.html :: footer}"></th:block>
			<th:block th:insert="~{inc/asset.html :: templates_js}"></th:block>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	document.querySelector('input[type="radio"]').checked = true;
	
	// CSRF 토큰과 헤더 이름을 메타 태그에서 동적으로 가져옵니다.
	//var token = $("meta[name='_csrf']").attr("content");
	//var header = $("meta[name='_csrf_header']").attr("content");
	
	
	// 페이지 로딩 시 첫 번째 라디오 버튼에 해당하는 성분을 선택하여 처리
	document.addEventListener('DOMContentLoaded', function() {
	   
	    let firstLabel = document.querySelector('label');
	    let firstInput = document.querySelector('#' + firstLabel.getAttribute('for'));
	    let firstIngredientSeq = firstInput.value;
	    let firstIngredient = firstLabel.textContent.trim();
	
	    // 첫 번째 라디오 버튼에 해당하는 성분을 표시
	    selectIngredient(firstIngredientSeq, firstIngredient);
	});
	
	
	
	// 클릭된 label에 연결된 input 요소 가져오기
	document.querySelectorAll('label').forEach(function (label) {
	    label.addEventListener('click', function () {
	        
	        let input = document.querySelector('#' + label.getAttribute('for'));
	        let ingredientSeq = input.value;
	        let ingredient = label.textContent.trim();
	
	        // selectIngredient 함수 호출
	        selectIngredient(ingredientSeq, ingredient);
	    });
	});
	
	
	
	// 성분을 업데이트하는 함수
	function selectIngredient(ingredientSeq, ingredient) {
		// ajax 함수와 충돌나서 none으로 초기화 추가
		document.querySelector('#combinationBad').style.display = 'none';
		document.querySelector('#combinationGood').style.display = 'none';
		document.querySelector('#collapseOne').innerHTML ='';
		document.querySelector('#collapseTwo').innerHTML ='';
	
	    // 라디오 버튼을 누르면 선택된 성분 보여주기로 변경
	    document.querySelectorAll('.selectOne')[0].innerHTML = ingredient;
	    document.querySelectorAll('.selectOne')[1].innerHTML = ingredient;
	
	    // 라디오 버튼을 누르면 선택된 성분 이미지 보여주기로 변경
	    let image = document.querySelector('#selectOneImg');
	    image.src = '/img/ingredient/' + ingredient + '.png';
	
	    // AJAX 요청
	    $.ajax({
	        type: 'POST',
	        url: '/combination/ajax',  // 서버에 요청할 URL
	        dataType: 'json',
	        contentType: 'application/json',
	        data: JSON.stringify({
	            ingredientSeq: ingredientSeq,
	            ingredient: ingredient
	        }),
	        success: function (response) {
				
				if (response.good && response.good.length > 0 && response.bad && response.bad.length > 0) {
				    // bad와 good 모두 있을 때
				    displayCombination('#combinationBad', response.bad[0].functionalContent);
				    displayCombination('#combinationGood', response.good[0].functionalContent);
				    addGoodCombinations(response.good);
				    addBadCombinations(response.bad);
				} else if (response.bad && response.bad.length > 0) {
				    // bad만 있을 때
				    displayCombination('#combinationBad', response.bad[0].functionalContent);
				    console.log('bad functionalContent: ' + response.bad[0].functionalContent);
				    addBadCombinations(response.bad);
				} else if (response.good && response.good.length > 0) {
				    // good만 있을 때
				    displayCombination('#combinationGood', response.good[0].functionalContent);
				    console.log('good functionalContent: ' + response.good[0].functionalContent);
				    addGoodCombinations(response.good);
				}
	        },
	        error: function (a, b, c) {
	            console.log(a, b, c);
	        }
	    });
	}
	


	function displayCombination(elementId, content) {
		// 해당 요소의 display를 'block'으로 설정하고, content를 삽입
	    document.querySelector(elementId).style.display = 'block';
	    document.querySelector('#ingredientContent').innerHTML = content;
	}

	// 'good' 배열을 순회하면서 각 항목에 대한 HTML을 동적으로 추가하는 함수
	function addGoodCombinations(goodArray) {
	    // 'good' 배열이 존재하고 길이가 0보다 큰지 확인
	    if (goodArray && goodArray.length > 0) {
	      	let collapseOne = document.querySelector('#collapseOne');
	      	
	        // 새로운 요소를 만들고 해당 위치에 추가할 HTML 문자열을 생성
	        let newElement = document.createElement('div'); // 하나의 div로 여러 항목을 감쌀 예정
	
	        // 'good' 배열을 순회하면서 각 항목에 대한 HTML을 생성
	        goodArray.forEach(function(item, index) {
	            // 각 항목에 대해 HTML 요소 생성
	            let goodItemHTML = `
	            	<div class="accordion-body">
	                	<div class="good_combination_title">${item.name}</div>
	                	<div class="good_combination_content">${item.reason}</div>
	                	<a class="good_combination_link" href="${item.link}" target="_blank">출처</a>
	                </div>
	            `;
	
	            // 새로운 div 요소를 생성하여 HTML 삽입
            	let newElement = document.createElement('div');
            	newElement.innerHTML = goodItemHTML;

            	// #collapseTwo 내부에 새로운 항목 추가
            	collapseOne.appendChild(newElement);
	
	       });
	        
	
	    } else {
	        console.log('No good combinations available.');
	    }
	}
	
	// 'bad' 배열을 순회하면서 각 항목에 대한 HTML을 동적으로 추가하는 함수
	function addBadCombinations(badArray) {
	    // 'bad' 배열이 존재하고 길이가 0보다 큰지 확인
	    if (badArray && badArray.length > 0) {
	        let collapseTwo = document.querySelector('#collapseTwo');
	
	        // 새로운 요소를 만들고 해당 위치에 추가할 HTML 문자열을 생성
	        let newElement = document.createElement('div'); // 하나의 div로 여러 항목을 감쌀 예정
	
	        // 'good' 배열을 순회하면서 각 항목에 대한 HTML을 생성
	        badArray.forEach(function(item, index) {
	            // 각 항목에 대해 HTML 요소 생성
	            let badItemHTML = `
	            	<div class="accordion-body">
	                	<div class="bad_combination_title">${item.name}</div>
	                	<div class="bad_combination_content">${item.reason}</div>
	                	<a class="bad_combination_link" href="${item.link}" target="_blank">출처</a>
	                </div>
	            `;
	
	            // 새로운 div 요소를 생성하여 HTML 삽입
            	let newElement = document.createElement('div');
            	newElement.innerHTML = badItemHTML;

            	// #collapseTwo 내부에 새로운 항목 추가
            	collapseTwo.appendChild(newElement);
	
	            // 콘솔에 로그 출력 (디버깅용)
	            console.log(`bad[${index}] - Name: ${item.name}, Reason: ${item.reason}, Link: ${item.link}`);
	        });
	
	       
	    } else {
	        console.log('No bad combinations available.');
	    }
	}
	
	
	

</script>

</html>